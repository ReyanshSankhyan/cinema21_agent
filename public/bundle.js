(()=>{"use strict";function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},e.apply(null,arguments)}function t(e){const t=new Uint8Array(e);return window.btoa(String.fromCharCode(...t))}function n(e){const t=window.atob(e),n=t.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=t.charCodeAt(e);return o.buffer}const o=new Map;function a(e,t){return async n=>{const a=o.get(e);if(a)return n.addModule(a);const i=new Blob([t],{type:"application/javascript"}),s=URL.createObjectURL(i);try{return await n.addModule(s),void o.set(e,s)}catch(e){URL.revokeObjectURL(s)}try{const a=`data:application/javascript;base64,${btoa(t)}`;await n.addModule(a),o.set(e,a)}catch(t){throw new Error(`Failed to load the ${e} worklet module. Make sure the browser supports AudioWorklets.`)}}}const i=a("raw-audio-processor",'\nconst BIAS = 0x84;\nconst CLIP = 32635;\nconst encodeTable = [\n  0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,\n  4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,\n  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7\n];\n\nfunction encodeSample(sample) {\n  let sign;\n  let exponent;\n  let mantissa;\n  let muLawSample;\n  sign = (sample >> 8) & 0x80;\n  if (sign !== 0) sample = -sample;\n  sample = sample + BIAS;\n  if (sample > CLIP) sample = CLIP;\n  exponent = encodeTable[(sample>>7) & 0xFF];\n  mantissa = (sample >> (exponent+3)) & 0x0F;\n  muLawSample = ~(sign | (exponent << 4) | mantissa);\n  \n  return muLawSample;\n}\n\nclass RawAudioProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n              \n    this.port.onmessage = ({ data }) => {\n      switch (data.type) {\n        case "setFormat":\n          this.isMuted = false;\n          this.buffer = []; // Initialize an empty buffer\n          this.bufferSize = data.sampleRate / 4;\n          this.format = data.format;\n\n          if (globalThis.LibSampleRate && sampleRate !== data.sampleRate) {\n            globalThis.LibSampleRate.create(1, sampleRate, data.sampleRate).then(resampler => {\n              this.resampler = resampler;\n            });\n          }\n          break;\n        case "setMuted":\n          this.isMuted = data.isMuted;\n          break;\n      }\n    };\n  }\n  process(inputs) {\n    if (!this.buffer) {\n      return true;\n    }\n    \n    const input = inputs[0]; // Get the first input node\n    if (input.length > 0) {\n      let channelData = input[0]; // Get the first channel\'s data\n\n      // Resample the audio if necessary\n      if (this.resampler) {\n        channelData = this.resampler.full(channelData);\n      }\n\n      // Add channel data to the buffer\n      this.buffer.push(...channelData);\n      // Get max volume \n      let sum = 0.0;\n      for (let i = 0; i < channelData.length; i++) {\n        sum += channelData[i] * channelData[i];\n      }\n      const maxVolume = Math.sqrt(sum / channelData.length);\n      // Check if buffer size has reached or exceeded the threshold\n      if (this.buffer.length >= this.bufferSize) {\n        const float32Array = this.isMuted \n          ? new Float32Array(this.buffer.length)\n          : new Float32Array(this.buffer);\n\n        let encodedArray = this.format === "ulaw"\n          ? new Uint8Array(float32Array.length)\n          : new Int16Array(float32Array.length);\n\n        // Iterate through the Float32Array and convert each sample to PCM16\n        for (let i = 0; i < float32Array.length; i++) {\n          // Clamp the value to the range [-1, 1]\n          let sample = Math.max(-1, Math.min(1, float32Array[i]));\n\n          // Scale the sample to the range [-32768, 32767]\n          let value = sample < 0 ? sample * 32768 : sample * 32767;\n          if (this.format === "ulaw") {\n            value = encodeSample(Math.round(value));\n          }\n\n          encodedArray[i] = value;\n        }\n\n        // Send the buffered data to the main script\n        this.port.postMessage([encodedArray, maxVolume]);\n\n        // Clear the buffer after sending\n        this.buffer = [];\n      }\n    }\n    return true; // Continue processing\n  }\n}\nregisterProcessor("raw-audio-processor", RawAudioProcessor);\n');function s(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}class r{static async create({sampleRate:e,format:t,preferHeadphonesForIosDevices:n}){let o=null,a=null;try{const l={sampleRate:{ideal:e},echoCancellation:{ideal:!0},noiseSuppression:{ideal:!0}};if(s()&&n){const e=(await window.navigator.mediaDevices.enumerateDevices()).find(e=>"audioinput"===e.kind&&["airpod","headphone","earphone"].find(t=>e.label.toLowerCase().includes(t)));e&&(l.deviceId={ideal:e.deviceId})}const c=navigator.mediaDevices.getSupportedConstraints().sampleRate;o=new window.AudioContext(c?{sampleRate:e}:{});const d=o.createAnalyser();c||await o.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/@alexanderolsen/libsamplerate-js@2.1.2/dist/libsamplerate.worklet.js"),await i(o.audioWorklet),a=await navigator.mediaDevices.getUserMedia({audio:l});const u=o.createMediaStreamSource(a),p=new AudioWorkletNode(o,"raw-audio-processor");return p.port.postMessage({type:"setFormat",format:t,sampleRate:e}),u.connect(d),d.connect(p),await o.resume(),new r(o,d,p,a)}catch(e){var l,c;throw null==(l=a)||l.getTracks().forEach(e=>e.stop()),null==(c=o)||c.close(),e}}constructor(e,t,n,o){this.context=void 0,this.analyser=void 0,this.worklet=void 0,this.inputStream=void 0,this.context=e,this.analyser=t,this.worklet=n,this.inputStream=o}async close(){this.inputStream.getTracks().forEach(e=>e.stop()),await this.context.close()}setMuted(e){this.worklet.port.postMessage({type:"setMuted",isMuted:e})}}const l=a("audio-concat-processor",'\nconst decodeTable = [0,132,396,924,1980,4092,8316,16764];\n\nexport function decodeSample(muLawSample) {\n  let sign;\n  let exponent;\n  let mantissa;\n  let sample;\n  muLawSample = ~muLawSample;\n  sign = (muLawSample & 0x80);\n  exponent = (muLawSample >> 4) & 0x07;\n  mantissa = muLawSample & 0x0F;\n  sample = decodeTable[exponent] + (mantissa << (exponent+3));\n  if (sign !== 0) sample = -sample;\n\n  return sample;\n}\n\nclass AudioConcatProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n    this.buffers = []; // Initialize an empty buffer\n    this.cursor = 0;\n    this.currentBuffer = null;\n    this.wasInterrupted = false;\n    this.finished = false;\n    \n    this.port.onmessage = ({ data }) => {\n      switch (data.type) {\n        case "setFormat":\n          this.format = data.format;\n          break;\n        case "buffer":\n          this.wasInterrupted = false;\n          this.buffers.push(\n            this.format === "ulaw"\n              ? new Uint8Array(data.buffer)\n              : new Int16Array(data.buffer)\n          );\n          break;\n        case "interrupt":\n          this.wasInterrupted = true;\n          break;\n        case "clearInterrupted":\n          if (this.wasInterrupted) {\n            this.wasInterrupted = false;\n            this.buffers = [];\n            this.currentBuffer = null;\n          }\n      }\n    };\n  }\n  process(_, outputs) {\n    let finished = false;\n    const output = outputs[0][0];\n    for (let i = 0; i < output.length; i++) {\n      if (!this.currentBuffer) {\n        if (this.buffers.length === 0) {\n          finished = true;\n          break;\n        }\n        this.currentBuffer = this.buffers.shift();\n        this.cursor = 0;\n      }\n\n      let value = this.currentBuffer[this.cursor];\n      if (this.format === "ulaw") {\n        value = decodeSample(value);\n      }\n      output[i] = value / 32768;\n      this.cursor++;\n\n      if (this.cursor >= this.currentBuffer.length) {\n        this.currentBuffer = null;\n      }\n    }\n\n    if (this.finished !== finished) {\n      this.finished = finished;\n      this.port.postMessage({ type: "process", finished });\n    }\n\n    return true; // Continue processing\n  }\n}\n\nregisterProcessor("audio-concat-processor", AudioConcatProcessor);\n');class c{static async create({sampleRate:e,format:t}){let n=null;try{n=new AudioContext({sampleRate:e});const o=n.createAnalyser(),a=n.createGain();a.connect(o),o.connect(n.destination),await l(n.audioWorklet);const i=new AudioWorkletNode(n,"audio-concat-processor");return i.port.postMessage({type:"setFormat",format:t}),i.connect(a),await n.resume(),new c(n,o,a,i)}catch(e){var o;throw null==(o=n)||o.close(),e}}constructor(e,t,n,o){this.context=void 0,this.analyser=void 0,this.gain=void 0,this.worklet=void 0,this.context=e,this.analyser=t,this.gain=n,this.worklet=o}async close(){await this.context.close()}}function d(e){return!!e.type}class u{static async create(e){let t=null;try{var n;const o=null!=(n=e.origin)?n:"wss://api.elevenlabs.io",a=e.signedUrl?e.signedUrl:o+"/v1/convai/conversation?agent_id="+e.agentId,i=["convai"];e.authorization&&i.push(`bearer.${e.authorization}`),t=new WebSocket(a,i);const s=await new Promise((n,o)=>{t.addEventListener("open",()=>{var n;const o={type:"conversation_initiation_client_data"};var a,i,s,r;e.overrides&&(o.conversation_config_override={agent:{prompt:null==(a=e.overrides.agent)?void 0:a.prompt,first_message:null==(i=e.overrides.agent)?void 0:i.firstMessage,language:null==(s=e.overrides.agent)?void 0:s.language},tts:{voice_id:null==(r=e.overrides.tts)?void 0:r.voiceId}}),e.customLlmExtraBody&&(o.custom_llm_extra_body=e.customLlmExtraBody),e.dynamicVariables&&(o.dynamic_variables=e.dynamicVariables),null==(n=t)||n.send(JSON.stringify(o))},{once:!0}),t.addEventListener("error",e=>{setTimeout(()=>o(e),0)}),t.addEventListener("close",o),t.addEventListener("message",e=>{const t=JSON.parse(e.data);d(t)&&("conversation_initiation_metadata"===t.type?n(t.conversation_initiation_metadata_event):console.warn("First received message is not conversation metadata."))},{once:!0})}),{conversation_id:r,agent_output_audio_format:l,user_input_audio_format:c}=s,m=p(null!=c?c:"pcm_16000"),h=p(l);return new u(t,r,m,h)}catch(e){var o;throw null==(o=t)||o.close(),e}}constructor(e,t,n,o){this.socket=void 0,this.conversationId=void 0,this.inputFormat=void 0,this.outputFormat=void 0,this.queue=[],this.disconnectionDetails=null,this.onDisconnectCallback=null,this.onMessageCallback=null,this.socket=e,this.conversationId=t,this.inputFormat=n,this.outputFormat=o,this.socket.addEventListener("error",e=>{setTimeout(()=>this.disconnect({reason:"error",message:"The connection was closed due to a socket error.",context:e}),0)}),this.socket.addEventListener("close",e=>{this.disconnect(1e3===e.code?{reason:"agent",context:e}:{reason:"error",message:e.reason||"The connection was closed by the server.",context:e})}),this.socket.addEventListener("message",e=>{try{const t=JSON.parse(e.data);if(!d(t))return;this.onMessageCallback?this.onMessageCallback(t):this.queue.push(t)}catch(e){}})}close(){this.socket.close()}sendMessage(e){this.socket.send(JSON.stringify(e))}onMessage(e){this.onMessageCallback=e,this.queue.forEach(e),this.queue=[]}onDisconnect(e){this.onDisconnectCallback=e,this.disconnectionDetails&&e(this.disconnectionDetails)}disconnect(e){var t;this.disconnectionDetails||(this.disconnectionDetails=e,null==(t=this.onDisconnectCallback)||t.call(this,e))}}function p(e){const[t,n]=e.split("_");if(!["pcm","ulaw"].includes(t))throw new Error(`Invalid format: ${e}`);const o=parseInt(n);if(isNaN(o))throw new Error(`Invalid sample rate: ${n}`);return{format:t,sampleRate:o}}const m={clientTools:{}},h={onConnect:()=>{},onDebug:()=>{},onDisconnect:()=>{},onError:()=>{},onMessage:()=>{},onAudio:()=>{},onModeChange:()=>{},onStatusChange:()=>{},onCanSendFeedbackChange:()=>{}};class f{static async startSession(t){var n;const o=e({},m,h,t);o.onStatusChange({status:"connecting"}),o.onCanSendFeedbackChange({canSendFeedback:!1});let a=null,i=null,l=null,d=null,p=null;if(null==(n=t.useWakeLock)||n)try{p=await navigator.wakeLock.request("screen")}catch(e){}try{var g,v;d=await navigator.mediaDevices.getUserMedia({audio:!0});const n=null!=(g=t.connectionDelay)?g:{default:0,android:3e3};let m=n.default;var y;if(/android/i.test(navigator.userAgent))m=null!=(y=n.android)?y:m;else if(s()){var w;m=null!=(w=n.ios)?w:m}return m>0&&await new Promise(e=>setTimeout(e,m)),i=await u.create(t),[a,l]=await Promise.all([r.create(e({},i.inputFormat,{preferHeadphonesForIosDevices:t.preferHeadphonesForIosDevices})),c.create(i.outputFormat)]),null==(v=d)||v.getTracks().forEach(e=>e.stop()),d=null,new f(o,i,a,l,p)}catch(e){var _,b,x,k;o.onStatusChange({status:"disconnected"}),null==(_=d)||_.getTracks().forEach(e=>e.stop()),null==(b=i)||b.close(),await(null==(x=a)?void 0:x.close()),await(null==(k=l)?void 0:k.close());try{var M;await(null==(M=p)?void 0:M.release()),p=null}catch(e){}throw e}}constructor(e,o,a,i,s){var r=this;this.options=void 0,this.connection=void 0,this.input=void 0,this.output=void 0,this.wakeLock=void 0,this.lastInterruptTimestamp=0,this.mode="listening",this.status="connecting",this.inputFrequencyData=void 0,this.outputFrequencyData=void 0,this.volume=1,this.currentEventId=1,this.lastFeedbackEventId=1,this.canSendFeedback=!1,this.endSession=()=>this.endSessionWithDetails({reason:"user"}),this.endSessionWithDetails=async function(e){if("connected"===r.status||"connecting"===r.status){r.updateStatus("disconnecting");try{var t;await(null==(t=r.wakeLock)?void 0:t.release()),r.wakeLock=null}catch(e){}r.connection.close(),await r.input.close(),await r.output.close(),r.updateStatus("disconnected"),r.options.onDisconnect(e)}},this.updateMode=e=>{e!==this.mode&&(this.mode=e,this.options.onModeChange({mode:e}))},this.updateStatus=e=>{e!==this.status&&(this.status=e,this.options.onStatusChange({status:e}))},this.updateCanSendFeedback=()=>{const e=this.currentEventId!==this.lastFeedbackEventId;this.canSendFeedback!==e&&(this.canSendFeedback=e,this.options.onCanSendFeedbackChange({canSendFeedback:e}))},this.onMessage=async function(e){switch(e.type){case"interruption":return e.interruption_event&&(r.lastInterruptTimestamp=e.interruption_event.event_id),void r.fadeOutAudio();case"agent_response":return void r.options.onMessage({source:"ai",message:e.agent_response_event.agent_response});case"user_transcript":return void r.options.onMessage({source:"user",message:e.user_transcription_event.user_transcript});case"internal_tentative_agent_response":return void r.options.onDebug({type:"tentative_agent_response",response:e.tentative_agent_response_internal_event.tentative_agent_response});case"client_tool_call":if(r.options.clientTools.hasOwnProperty(e.client_tool_call.tool_name))try{var t;const n=null!=(t=await r.options.clientTools[e.client_tool_call.tool_name](e.client_tool_call.parameters))?t:"Client tool execution successful.",o="object"==typeof n?JSON.stringify(n):String(n);r.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:o,is_error:!1})}catch(t){r.onError("Client tool execution failed with following error: "+(null==t?void 0:t.message),{clientToolName:e.client_tool_call.tool_name}),r.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:"Client tool execution failed: "+(null==t?void 0:t.message),is_error:!0})}else{if(r.options.onUnhandledClientToolCall)return void r.options.onUnhandledClientToolCall(e.client_tool_call);r.onError(`Client tool with name ${e.client_tool_call.tool_name} is not defined on client`,{clientToolName:e.client_tool_call.tool_name}),r.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:`Client tool with name ${e.client_tool_call.tool_name} is not defined on client`,is_error:!0})}return;case"audio":return void(r.lastInterruptTimestamp<=e.audio_event.event_id&&(r.options.onAudio(e.audio_event.audio_base_64),r.addAudioBase64Chunk(e.audio_event.audio_base_64),r.currentEventId=e.audio_event.event_id,r.updateCanSendFeedback(),r.updateMode("speaking")));case"ping":return void r.connection.sendMessage({type:"pong",event_id:e.ping_event.event_id});default:return void r.options.onDebug(e)}},this.onInputWorkletMessage=e=>{"connected"===this.status&&this.connection.sendMessage({user_audio_chunk:t(e.data[0].buffer)})},this.onOutputWorkletMessage=({data:e})=>{"process"===e.type&&this.updateMode(e.finished?"listening":"speaking")},this.addAudioBase64Chunk=e=>{this.output.gain.gain.value=this.volume,this.output.worklet.port.postMessage({type:"clearInterrupted"}),this.output.worklet.port.postMessage({type:"buffer",buffer:n(e)})},this.fadeOutAudio=()=>{this.updateMode("listening"),this.output.worklet.port.postMessage({type:"interrupt"}),this.output.gain.gain.exponentialRampToValueAtTime(1e-4,this.output.context.currentTime+2),setTimeout(()=>{this.output.gain.gain.value=this.volume,this.output.worklet.port.postMessage({type:"clearInterrupted"})},2e3)},this.onError=(e,t)=>{console.error(e,t),this.options.onError(e,t)},this.calculateVolume=e=>{if(0===e.length)return 0;let t=0;for(let n=0;n<e.length;n++)t+=e[n]/255;return t/=e.length,t<0?0:t>1?1:t},this.getId=()=>this.connection.conversationId,this.isOpen=()=>"connected"===this.status,this.setVolume=({volume:e})=>{this.volume=e},this.setMicMuted=e=>{this.input.setMuted(e)},this.getInputByteFrequencyData=()=>(null!=this.inputFrequencyData||(this.inputFrequencyData=new Uint8Array(this.input.analyser.frequencyBinCount)),this.input.analyser.getByteFrequencyData(this.inputFrequencyData),this.inputFrequencyData),this.getOutputByteFrequencyData=()=>(null!=this.outputFrequencyData||(this.outputFrequencyData=new Uint8Array(this.output.analyser.frequencyBinCount)),this.output.analyser.getByteFrequencyData(this.outputFrequencyData),this.outputFrequencyData),this.getInputVolume=()=>this.calculateVolume(this.getInputByteFrequencyData()),this.getOutputVolume=()=>this.calculateVolume(this.getOutputByteFrequencyData()),this.sendFeedback=e=>{this.canSendFeedback?(this.connection.sendMessage({type:"feedback",score:e?"like":"dislike",event_id:this.currentEventId}),this.lastFeedbackEventId=this.currentEventId,this.updateCanSendFeedback()):console.warn(0===this.lastFeedbackEventId?"Cannot send feedback: the conversation has not started yet.":"Cannot send feedback: feedback has already been sent for the current response.")},this.sendContextualUpdate=e=>{this.connection.sendMessage({type:"contextual_update",text:e})},this.sendUserMessage=e=>{this.connection.sendMessage({type:"user_message",text:e})},this.sendUserActivity=()=>{this.connection.sendMessage({type:"user_activity"})},this.options=e,this.connection=o,this.input=a,this.output=i,this.wakeLock=s,this.options.onConnect({conversationId:o.conversationId}),this.connection.onDisconnect(this.endSessionWithDetails),this.connection.onMessage(this.onMessage),this.input.worklet.port.onmessage=this.onInputWorkletMessage,this.output.worklet.port.onmessage=this.onOutputWorkletMessage,this.updateStatus("connected")}}let g=null,v=null,y=null,w="idle",_=!1,b=!1;const x={idle:["https://files.cekat.ai/idle01_WdhEBA.mp4","https://files.cekat.ai/idle02_wzwOwW.mp4","https://files.cekat.ai/idle03_hSgkmT.mp4","https://files.cekat.ai/idle04_fvKDOd.mp4"],talk:["https://files.cekat.ai/talk01_zJhWdX.mp4","https://files.cekat.ai/talk02_ZbJZsx.mp4","https://files.cekat.ai/talk03_nGR0b5.mp4"],food:"https://files.cekat.ai/food01_hEuNQr.mp4",cart:"https://files.cekat.ai/cart01_UNaXIH.mp4",movie:"https://files.cekat.ai/movie01_CPEwjH.mp4",order:"https://files.cekat.ai/order01_iXSyRa.mp4"};let k=0,M=0,E=!1;const S={display_movie_info:async({movies:e})=>({success:!0}),display_showtimes_info:async({cinema_name:e,movies:t})=>({success:!0}),show_cinemas_showtimes:async({cinema_name:e,movies:t})=>(v="show_cinemas_showtimes",y={cinema_name:e,movies:t},B.show_cinemas_showtimes={cinema_name:e,movies:t},C(),async function(){const e=document.getElementById("avatar-video");if(!e)return;const t="talk"===w;b=!0,e.src=x.movie,e.load(),await D(e),await new Promise(t=>{e.addEventListener("ended",t,{once:!0})}),b=!1,L(t?"talk":"idle")}(),{success:!0}),update_cart:async({cart_items:e})=>(v="update_cart",y={cart_items:e},B.update_cart={cart_items:e},C(),async function(){const e=document.getElementById("avatar-video");if(!e)return;const t="talk"===w;b=!0,e.src=x.cart,e.load(),await D(e),await new Promise(t=>{e.addEventListener("ended",t,{once:!0})}),b=!1,L(t?"talk":"idle")}(),{success:!0}),show_food_items:async({food_items:e})=>(v="show_food_items",y={food_items:e},B.show_food_items={food_items:e},C(),async function(){const e=document.getElementById("avatar-video");if(!e)return;const t="talk"===w;b=!0,e.src=x.food,e.load(),await D(e),await new Promise(t=>{e.addEventListener("ended",t,{once:!0})}),b=!1,L(t?"talk":"idle")}(),{success:!0}),place_order:async()=>(v="place_order",y={},B.place_order={},C(),async function(){const e=document.getElementById("avatar-video");if(!e)return;const t="talk"===w;b=!0,e.src=x.order,e.load(),await D(e),await new Promise(t=>{e.addEventListener("ended",t,{once:!0})}),b=!1,L(t?"talk":"idle")}(),{success:!0}),play_movie_trailer:async({movie_code:e})=>(v="play_movie_trailer",y={movie_code:e},B.play_movie_trailer={movie_code:e},C(),{success:!0}),set_movie_selection:async({movie_name:e,showtime:t})=>(v="set_movie_selection",y={movie_name:e,showtime:t},B.set_movie_selection={movie_name:e,showtime:t},C(),{success:!0})};function C(){const e=document.getElementById("bottom-panel"),t=document.getElementById("bottom-panel-content"),n=document.getElementById("cart-panel");let o="";const a=B.set_movie_selection;o+=`\n    <div style="border-bottom: 1px solid #ece7df; padding-bottom: 15px; margin-bottom: 15px;">\n      <div style="font-weight: 600; color: #2d2a22; margin-bottom: 8px; font-size: 1rem;">Movie Selection</div>\n      <div style="color: #555; font-size: 0.9em;">\n        ${a?`<div><strong>Movie:</strong> ${a.movie_name}</div>\n           <div><strong>Showtime:</strong> ${a.showtime}</div>`:'<div style="color: #aaa; font-style: italic;">No movie selected</div>'}\n      </div>\n    </div>\n  `;const i=B.update_cart||("update_cart"===v?y:null);if(i&&i.cart_items&&i.cart_items.length>0?o+=T("update_cart",i,!1):o+='<div style="color:#aaa;text-align:center;padding-top:20px;">Cart Empty</div>',n.innerHTML=o,"place_order"===v&&y)!function(){const e=document.getElementById("orderConfirmationModal"),t=document.getElementById("orderConfirmationContent"),n=B.set_movie_selection,o=B.update_cart;let a=`\n    <div style="text-align: center; padding: 30px; max-width: 500px; margin: 0 auto;">\n      <div style="margin-bottom: 25px;">\n        <div style="font-size: 48px; margin-bottom: 15px;">ðŸŽ¬</div>\n        <h2 style="color: #2d2a22; margin: 0; font-size: 24px; font-weight: 600;">Order Confirmed!</h2>\n        <p style="color: #666; margin: 8px 0 0 0; font-size: 14px;">Your booking has been successfully placed</p>\n      </div>\n      \n      <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #dee2e6;">\n        <h3 style="color: #2d2a22; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">Movie Details</h3>\n        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">\n          <span style="color: #555; font-weight: 500;">Movie:</span>\n          <span style="color: #2d2a22; font-weight: 600;">${n?n.movie_name:"N/A"}</span>\n        </div>\n        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">\n          <span style="color: #555; font-weight: 500;">Showtime:</span>\n          <span style="color: #2d2a22; font-weight: 600;">${n?n.showtime:"N/A"}</span>\n        </div>\n      </div>\n  `;if(o&&o.cart_items&&o.cart_items.length>0){a+='\n      <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #dee2e6;">\n        <h3 style="color: #2d2a22; margin: 0 0 15px 0; font-size: 18px; font-weight: 600;">Food Order</h3>\n        <div style="text-align: left;">\n    ';let e=0;o.cart_items.forEach(t=>{const n=t.quantity*t.price;e+=n,a+=`\n        <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 8px 12px; background: rgba(255,255,255,0.7); border-radius: 8px;">\n          <span style="color: #2d2a22; font-weight: 500;">${t.name} Ã— ${t.quantity}</span>\n          <span style="color: #2d2a22; font-weight: 600;">Rp${n.toLocaleString()}</span>\n        </div>\n      `}),a+=`\n          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 12px 0; border-top: 2px solid #dee2e6; font-weight: bold; font-size: 16px;">\n            <span style="color: #2d2a22;">Total:</span>\n            <span style="color: #2d2a22;">Rp${e.toLocaleString()}</span>\n          </div>\n        </div>\n      </div>\n    `}a+=`\n      <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-radius: 16px; padding: 20px; margin-bottom: 25px; border: 1px solid #c3e6cb;">\n        <h4 style="color: #155724; margin: 0 0 10px 0; font-size: 16px; font-weight: 600;">Pickup Information</h4>\n        <p style="margin: 0; color: #155724; font-weight: 500; line-height: 1.4;">\n          Your movie will play at <strong>Studio 1</strong> at ${n?n.showtime:"N/A"}, and you can pick up your order at <strong>Pickup 3</strong>.\n        </p>\n      </div>\n      \n      <button onclick="window.closeOrderConfirmationModal()" style="\n        background: linear-gradient(135deg, #7b8c5a 0%, #6c7b4a 100%);\n        color: white;\n        border: none;\n        padding: 14px 32px;\n        border-radius: 12px;\n        cursor: pointer;\n        font-size: 16px;\n        font-weight: 600;\n        box-shadow: 0 4px 12px rgba(123, 140, 90, 0.3);\n        transition: all 0.2s ease;\n      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(123, 140, 90, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(123, 140, 90, 0.3)'">\n        Close\n      </button>\n    </div>\n  `,t.innerHTML=a,e.style.display="block"}();else if("play_movie_trailer"===v&&y)!function(e){I();const{movie_code:t}=e,n=`\n    <div id="trailerModal" style="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100vw;\n      height: 100vh;\n      background-color: rgba(0, 0, 0, 0.8);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      z-index: 10000;\n    ">\n      <div style="\n        position: relative;\n        width: 100vw;\n        height: 100vh;\n        background: #000;\n        overflow: hidden;\n      ">\n        <button onclick="closeTrailerModal()" style="\n          position: absolute;\n          top: 20px;\n          right: 20px;\n          background: rgba(0, 0, 0, 0.7);\n          color: white;\n          border: none;\n          border-radius: 50%;\n          width: 60px;\n          height: 60px;\n          font-size: 28px;\n          cursor: pointer;\n          z-index: 10001;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        ">Ã—</button>\n        <video controls autoplay style="\n          width: 100vw;\n          height: 100vh;\n          object-fit: cover;\n        ">\n          <source src="https://nos.jkt-1.neo.id/media.cinema21.co.id/movie-trailer/${t}.mp4" type="video/mp4">\n          Your browser does not support the video tag.\n        </video>\n      </div>\n    </div>\n  `;document.body.insertAdjacentHTML("beforeend",n)}(y);else if("show_cinemas_showtimes"===v||"show_food_items"===v)e.style.display="block",t.innerHTML=T(v,y,!1);else if("update_cart"===v){if("none"===e.style.display){const n=B.show_cinemas_showtimes,o=B.show_food_items;n?(e.style.display="block",t.innerHTML=T("show_cinemas_showtimes",n,!1)):o&&(e.style.display="block",t.innerHTML=T("show_food_items",o,!1))}}else e.style.display="none"}function I(){const e=document.getElementById("trailerModal");e&&e.remove()}function L(e){const t=document.getElementById("avatar-video");if(!t)return;if(b)return;w=e;const n=function(e){if("talk"===e){const e=Math.floor(Math.random()*x.talk.length);return x.talk[e]}{const e=Math.floor(Math.random()*x.idle.length);return x.idle[e]}}(e);t.pause(),t.src=n,t.load(),F(t)}function F(e,t=0){e.play().then(()=>{_=!0}).catch(n=>{console.error("Error playing video:",n),"AbortError"===n.name&&t<3&&(console.log(`Retrying video playback (attempt ${t+1}/3)`),setTimeout(()=>{F(e,t+1)},100))})}function A(e){L(e?"talk":"idle")}async function D(e,t=0){try{await e.play()}catch(n){if(console.error("Error playing video:",n),"AbortError"===n.name&&t<3)return console.log(`Retrying video playback (attempt ${t+1}/3)`),await new Promise(e=>setTimeout(e,100)),D(e,t+1);throw n}}window.closeOrderConfirmationModal=function(){document.getElementById("orderConfirmationModal").style.display="none"},window.closeTrailerModal=I;const B={};function T(e,t,n){if("show_cinemas_showtimes"===e||"display_showtimes_info"===e){const{cinema_name:e,movies:n}=t;let o="<div class='tool-title' style='font-size:1.1rem;font-weight:700;margin-bottom:10px;'>Showtimes</div>";o+='<div style="display:flex;gap:20px;margin-top:12px;">';for(const e of n||[]){o+=`<div style="min-width:200px;max-width:250px;padding:12px;border:1px solid #eee;border-radius:8px;background:#faf9f6;display:inline-block;height:140px;">\n        <div style="display:flex;align-items:center;gap:12px;height:100%;">\n          ${e.image_url?`<img src="${e.image_url}" alt="${e.movie_name}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;flex-shrink:0;">`:""}\n          <div style="flex:1;min-width:0;display:flex;flex-direction:column;justify-content:center;">\n            <div style="font-weight:600;color:#2d2a22;margin-bottom:8px;font-size:0.9em;line-height:1.2;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">${e.movie_name}</div>\n            <div style="display:flex;flex-wrap:wrap;gap:6px;">`;for(const t of e.showtimes||[])o+=`<span style="display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#fff;font-size:0.9em;">${t}</span>`;o+="</div></div></div></div>"}return o+="</div>",o}if("update_cart"===e){const e=t.cart_items||[];let o=`<div class='tool-title' style='font-size:${n?"2rem":"1.1rem"};font-weight:700;margin-bottom:10px;'>Your Cart</div>`;if(!Array.isArray(e)||0===e.length)return o+='<div style="color:#aaa;">Your cart is empty.</div>',o;const a=new Map;for(const t of e)t.name&&"number"==typeof t.price&&"number"==typeof t.quantity&&(a.has(t.name)?a.get(t.name).quantity+=t.quantity:a.set(t.name,{...t}));let i=0;o+='<ul style="list-style:none;padding:0;">';for(const e of a.values())o+=`<li style="margin-bottom:8px;padding:6px;border:1px solid #eee;border-radius:8px;display:flex;justify-content:space-between;align-items:center;background:#faf9f6;">\n        <span><b>${e.name}</b> x${e.quantity}</span>\n        <span>Rp${(e.price*e.quantity).toLocaleString()}</span>\n      </li>`,i+=e.price*e.quantity;return o+=`</ul><div style='margin-top:10px;font-weight:bold;font-size:1.1em;text-align:right;'>Total: Rp${i.toLocaleString()}</div>`,o}if("show_food_items"===e){const e=t.food_items||[];let n="<div class='tool-title' style='font-size:1.1rem;font-weight:700;margin-bottom:10px;'>Food Menu</div><div style=\"display:flex;gap:20px;\">";for(const t of e.slice(0,10))n+=`<div style="min-width:200px;max-width:250px;padding:12px;border:1px solid #eee;border-radius:8px;background:#faf9f6;display:inline-block;height:140px;">\n        <div style="display:flex;align-items:center;gap:12px;height:100%;">\n          ${t.image_url?`<img src="${t.image_url}" alt="${t.name}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;flex-shrink:0;">`:""}\n          <div style="flex:1;min-width:0;display:flex;flex-direction:column;justify-content:center;">\n            <b style="font-size:0.9em;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;line-height:1.2;">${t.name}</b>\n            <span style='color:#7b8c5a;font-size:0.9em;margin-top:8px;'>Price: Rp${t.price.toLocaleString()}</span>\n          </div>\n        </div>\n      </div>`;return n+="</div>",n}return'<div style="color:#aaa;">No data</div>'}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("avatar-video");e&&(e.addEventListener("ended",function(){b||e.play().catch(e=>{console.error("Error replaying video:",e)})}),A(!1))});const $={...S};function q(e){const t=document.getElementById("connectionStatus");t.textContent=e?"Connected":"Disconnected",t.classList.toggle("connected",e)}function P(e){const t=document.getElementById("speakingStatus"),n="speaking"===e.mode;t.textContent=n?"Agent Speaking":"Agent Silent",t.classList.toggle("speaking",n),A(n),console.log("Speaking status updated:",{mode:e,isSpeaking:n})}function R(e){const t=document.getElementById("startButton");t&&(e?(t.textContent="End Conversation",t.classList.add("end")):(t.textContent="Start Conversation",t.classList.remove("end")),t.disabled=!e)}["show_cinemas_showtimes","update_cart","show_food_items","play_movie_trailer","set_movie_selection"].forEach(e=>{S[e]=async t=>(v=e,y=t,B[e]=t,C(),$[e]?await $[e](t):{success:!0})}),C(),document.getElementById("closeSummaryModal").onclick=function(){document.getElementById("conversationSummaryModal").style.display="none"},document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("startButton");e&&(e.textContent="Start Conversation",e.classList.remove("end"),e.disabled=!0),function(){const e=document.getElementById("loading-overlay"),t=document.querySelector(".loading-text");M=x.idle.length+x.talk.length+4;const n=[];x.idle.forEach(e=>{const t=document.createElement("video");t.src=e,t.preload="auto",t.muted=!0,n.push(t)}),x.talk.forEach(e=>{const t=document.createElement("video");t.src=e,t.preload="auto",t.muted=!0,n.push(t)}),[x.food,x.cart,x.movie,x.order].forEach(e=>{const t=document.createElement("video");t.src=e,t.preload="auto",t.muted=!0,n.push(t)}),n.forEach(n=>{n.addEventListener("loadeddata",()=>{k++;const n=Math.round(k/M*100);t.textContent=`Loading videos... ${n}%`,k>=M&&(E=!0,e.style.display="none",R(!0))}),n.addEventListener("error",()=>{console.error("Failed to load video:",n.src),k++,k>=M&&(E=!0,e.style.display="none",R(!0))})})}()}),window.addEventListener("load",function(){const e=document.getElementById("startButton");e&&!g&&(e.textContent="Start Conversation",e.classList.remove("end"))}),window.onclick=function(e){const t=document.getElementById("conversationSummaryModal");e.target===t&&(t.style.display="none")},document.getElementById("startButton").addEventListener("click",async function(){if(g)try{await g.endSession(),g=null,R(!1),async function(){const e=document.getElementById("conversationSummaryModal"),t=document.getElementById("conversationSummaryContent");e.style.display="block",t.textContent="Loading...";try{const e=await fetch("/api/conversation-summary");if(!e.ok)throw new Error("Failed to fetch summary");const n=await e.json();let o="";n.transcriptSummary&&(o+=`<b>Transcript Summary:</b><br>${n.transcriptSummary}<br><br>`),n.summary&&(o+=`<b>Summary:</b><br>${n.summary}<br><br>`),n.transcript&&(o+="<b>Transcript:</b><br>"+n.transcript.map(e=>`<b>${e.role}:</b> ${e.message}`).join("<br>")),o||(o="No summary or transcript available."),t.innerHTML=o}catch(e){t.textContent="Error loading summary: "+e.message}}()}catch(e){alert("Failed to end conversation.")}else try{if(!await navigator.mediaDevices.getUserMedia({audio:!0}))return void alert("Microphone permission is required for the conversation.");const e=await fetch("/api/signed-url"),t=(await e.json()).signedUrl;g=await f.startSession({signedUrl:t,clientTools:S,onConnect:()=>{q(!0),R(!0)},onDisconnect:()=>{q(!1),R(!1),P({mode:"listening"})},onError:e=>{alert("An error occurred during the conversation.")},onModeChange:e=>{P(e)}}),R(!0)}catch(e){alert("Failed to start conversation. Please try again."),R(!1)}}),document.getElementById("deleteAllButton").addEventListener("click",async()=>{const e=document.getElementById("deleteAllButton");e.disabled=!0,e.textContent="Deleting...";try{if(!(await fetch("/api/delete-all",{method:"DELETE"})).ok)throw new Error("Failed to delete all");alert("All agents, voices, and tools deleted. The page will reload."),window.location.reload()}catch(t){alert("Failed to delete all: "+t.message),e.disabled=!1,e.textContent="Delete All"}});const z=document.getElementById("menuButton"),j=document.getElementById("menuBox");z.addEventListener("click",e=>{e.stopPropagation(),j.classList.toggle("show")}),document.addEventListener("click",e=>{j.contains(e.target)||z.contains(e.target)||j.classList.remove("show")}),window.addEventListener("error",function(e){console.error("Global error:",e.error)})})();